# Publisher æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ æ•´ä½“æ¶æ„

@ldesign/publisher é‡‡ç”¨æ¨¡å—åŒ–ã€åˆ†å±‚çš„æ¶æ„è®¾è®¡ï¼Œç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI Layer (CLI å±‚)                    â”‚
â”‚  Commands: publish, version, changelog, rollback,       â”‚
â”‚            precheck, stats                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Core Layer (æ ¸å¿ƒå±‚)                    â”‚
â”‚  PublishManager, VersionManager, ChangelogGenerator,    â”‚
â”‚  RegistryManager, DependencyResolver, RollbackManager,  â”‚
â”‚  HookManager, PublishAnalytics                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Validators Layer (éªŒè¯å±‚)                   â”‚
â”‚  PackageValidator, GitValidator, ConfigValidator        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Utils Layer (å·¥å…·å±‚)                      â”‚
â”‚  logger, error-handler, npm-client, git-utils,          â”‚
â”‚  workspace-utils, security, cache                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Types Layer (ç±»å‹å±‚)                     â”‚
â”‚  config, version, package, changelog, publish           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. PublishManager (å‘å¸ƒç®¡ç†å™¨)

**èŒè´£**: åè°ƒæ•´ä¸ªå‘å¸ƒæµç¨‹

**è®¾è®¡æ¨¡å¼**: é—¨é¢æ¨¡å¼ (Facade Pattern)

**æ ¸å¿ƒæµç¨‹**:
```typescript
publish() {
  1. æ‰§è¡Œ prePublish é’©å­
  2. åˆå§‹åŒ–ï¼ˆè§£æå·¥ä½œç©ºé—´ã€è·å–åŒ…åˆ—è¡¨ï¼‰
  3. éªŒè¯ï¼ˆGitã€åŒ…ã€ä¾èµ–ï¼‰
  4. æ„å»ºï¼ˆå¹¶è¡Œ/ä¸²è¡Œï¼‰
  5. æ›´æ–°ç‰ˆæœ¬
  6. ç”Ÿæˆ Changelog
  7. å‘å¸ƒåˆ° Registry
  8. Git æ“ä½œï¼ˆtagã€commitã€pushï¼‰
  9. è®°å½•ç»Ÿè®¡
  10. æ‰§è¡Œ postPublish é’©å­
  11. ç”ŸæˆæŠ¥å‘Š
}
```

**ä¾èµ–æ³¨å…¥**:
- RegistryManager
- VersionManager
- DependencyResolver
- ChangelogGenerator
- HookManager
- PackageValidator
- GitValidator

### 2. HookManager (é’©å­ç®¡ç†å™¨)

**èŒè´£**: ç®¡ç†ç”Ÿå‘½å‘¨æœŸé’©å­çš„æ‰§è¡Œ

**è®¾è®¡æ¨¡å¼**: è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

**æ”¯æŒçš„é’©å­**:
```typescript
- prePublish / postPublish     // å‘å¸ƒå‰å
- preVersion / postVersion     // ç‰ˆæœ¬æ›´æ–°å‰å
- preChangelog / postChangelog // Changelog ç”Ÿæˆå‰å
- preValidate / postValidate   // éªŒè¯å‰å
```

**é’©å­ç±»å‹**:
- å‘½ä»¤è¡Œå­—ç¬¦ä¸²: `'npm test'`
- å‡½æ•°: `async () => { ... }`
- æ•°ç»„: `['npm test', async () => {}]`

### 3. VersionManager (ç‰ˆæœ¬ç®¡ç†å™¨)

**èŒè´£**: ç‰ˆæœ¬å·çš„è¯»å–ã€æ›´æ–°å’ŒéªŒè¯

**æ ¸å¿ƒåŠŸèƒ½**:
- Semver ç‰ˆæœ¬é€’å¢
- åŸºäº Conventional Commits çš„ç‰ˆæœ¬æ¨è
- ç‰ˆæœ¬æ¯”è¾ƒå’ŒéªŒè¯
- æ‰¹é‡ç‰ˆæœ¬æ›´æ–°

**ä½¿ç”¨çš„åº“**:
- `semver` - ç‰ˆæœ¬å·å¤„ç†
- `conventional-recommended-bump` - ç‰ˆæœ¬æ¨è

### 4. ChangelogGenerator (Changelog ç”Ÿæˆå™¨)

**èŒè´£**: ç”Ÿæˆç¬¦åˆè§„èŒƒçš„å˜æ›´æ—¥å¿—

**æ ¸å¿ƒåŠŸèƒ½**:
- è§£æ Conventional Commits
- æŒ‰ç±»å‹åˆ†ç»„
- ç”Ÿæˆ Markdown æ ¼å¼
- æ™ºèƒ½ URL ç”Ÿæˆï¼ˆPRã€Commit é“¾æ¥ï¼‰

**æ”¯æŒçš„å¹³å°**:
- GitHub
- GitLab
- Gitee
- Bitbucket

### 5. DependencyResolver (ä¾èµ–è§£æå™¨)

**èŒè´£**: Monorepo ä¾èµ–å…³ç³»è§£æ

**æ ¸å¿ƒç®—æ³•**:
- æ‹“æ‰‘æ’åº (Topological Sort)
- å¾ªç¯ä¾èµ–æ£€æµ‹ (Circular Dependency Detection)
- ä¾èµ–å›¾æ„å»º (Dependency Graph)

**æ•°æ®ç»“æ„**:
```typescript
PackageDependencyGraph {
  packages: Map<name, PackageInfo>
  dependencies: Map<name, Set<dependency>>
  dependents: Map<name, Set<dependent>>
}
```

### 6. RegistryManager (Registry ç®¡ç†å™¨)

**èŒè´£**: NPM registry é…ç½®å’Œç®¡ç†

**æ ¸å¿ƒåŠŸèƒ½**:
- å¤š Registry é…ç½®
- Token ç®¡ç†
- Scope æ˜ å°„
- .npmrc æ–‡ä»¶è¯»å†™

### 7. ConfigValidator (é…ç½®éªŒè¯å™¨)

**èŒè´£**: éªŒè¯é…ç½®æ–‡ä»¶çš„æ­£ç¡®æ€§

**æŠ€æœ¯æ ˆ**: Zod

**éªŒè¯å±‚çº§**:
1. Schema éªŒè¯ï¼ˆç±»å‹ã€æ ¼å¼ï¼‰
2. ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆä¸€è‡´æ€§ã€åˆç†æ€§ï¼‰
3. è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œå»ºè®®

### 8. MemoryCache (ç¼“å­˜å·¥å…·)

**èŒè´£**: æä¾›é«˜æ€§èƒ½çš„å†…å­˜ç¼“å­˜

**æ ¸å¿ƒç‰¹æ€§**:
- TTL (Time To Live)
- LRU (Least Recently Used) é©±é€
- å‘½ä¸­ç‡ç»Ÿè®¡
- è‡ªåŠ¨æ¸…ç†

**åº”ç”¨åœºæ™¯**:
- Git æŸ¥è¯¢ç»“æœç¼“å­˜
- NPM Registry æŸ¥è¯¢ç¼“å­˜
- å·¥ä½œç©ºé—´ä¿¡æ¯ç¼“å­˜

### 9. PublishAnalytics (å‘å¸ƒç»Ÿè®¡)

**èŒè´£**: è®°å½•å’Œåˆ†æå‘å¸ƒå†å²

**æ ¸å¿ƒåŠŸèƒ½**:
- å‘å¸ƒè®°å½•æŒä¹…åŒ–
- ç»Ÿè®¡åˆ†æï¼ˆæˆåŠŸç‡ã€è€—æ—¶ï¼‰
- è¶‹åŠ¿åˆ†æï¼ˆæŒ‰æ—¥æœŸ/æœˆä»½ï¼‰
- æŠ¥å‘Šç”Ÿæˆ

## ğŸ”„ æ•°æ®æµ

### å‘å¸ƒæµç¨‹æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ (CLI)
    â”‚
    â”œâ”€> é…ç½®åŠ è½½ (ConfigLoader)
    â”‚       â”‚
    â”‚       â”œâ”€> é…ç½®éªŒè¯ (ConfigValidator)
    â”‚       â””â”€> åˆå¹¶é»˜è®¤é…ç½®
    â”‚
    â”œâ”€> å‘å¸ƒç®¡ç†å™¨ (PublishManager)
    â”‚       â”‚
    â”‚       â”œâ”€> æ‰§è¡Œé’©å­ (HookManager)
    â”‚       â”‚
    â”‚       â”œâ”€> ä¾èµ–è§£æ (DependencyResolver)
    â”‚       â”‚       â””â”€> å·¥ä½œç©ºé—´å·¥å…· (workspace-utils)
    â”‚       â”‚
    â”‚       â”œâ”€> éªŒè¯å™¨ (Validators)
    â”‚       â”‚       â”œâ”€> Git éªŒè¯
    â”‚       â”‚       â””â”€> åŒ…éªŒè¯
    â”‚       â”‚
    â”‚       â”œâ”€> æ„å»ºå™¨ (BuilderIntegration)
    â”‚       â”‚
    â”‚       â”œâ”€> ç‰ˆæœ¬ç®¡ç† (VersionManager)
    â”‚       â”‚       â””â”€> Git å·¥å…· (git-utils)
    â”‚       â”‚
    â”‚       â”œâ”€> Changelog ç”Ÿæˆ (ChangelogGenerator)
    â”‚       â”‚       â””â”€> Git å·¥å…· (git-utils)
    â”‚       â”‚
    â”‚       â”œâ”€> Registry å‘å¸ƒ (RegistryManager)
    â”‚       â”‚       â””â”€> NPM å®¢æˆ·ç«¯ (npm-client)
    â”‚       â”‚
    â”‚       â”œâ”€> Git æ“ä½œ (git-utils)
    â”‚       â”‚
    â”‚       â”œâ”€> ç»Ÿè®¡è®°å½• (PublishAnalytics)
    â”‚       â”‚
    â”‚       â””â”€> æ‰§è¡Œé’©å­ (HookManager)
    â”‚
    â””â”€> å‘å¸ƒæŠ¥å‘Š (PublishReport)
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)
æ¯ä¸ªç±»å’Œæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½ï¼š
- `VersionManager` åªç®¡ç†ç‰ˆæœ¬
- `ChangelogGenerator` åªç”Ÿæˆ Changelog
- `RegistryManager` åªç®¡ç† Registry

### 2. å¼€æ”¾å°é—­åŸåˆ™ (OCP)
é€šè¿‡é’©å­ç³»ç»Ÿå®ç°æ‰©å±•ï¼š
```typescript
// æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼Œé€šè¿‡é’©å­æ‰©å±•åŠŸèƒ½
hooks: {
  postPublish: async (report) => {
    await sendNotification(report)
  }
}
```

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°ï¼š
- ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºå®ä¾‹
- é€šè¿‡æ¥å£å®šä¹‰å¥‘çº¦
- ä¾èµ–æ³¨å…¥è€Œéç¡¬ç¼–ç 

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)
æä¾›æœ€å°åŒ–çš„æ¥å£ï¼š
- æ¯ä¸ª Manager åªæš´éœ²å¿…è¦çš„æ–¹æ³•
- é€šè¿‡ Options æ¥å£ä¼ é€’é…ç½®

### 5. é‡Œæ°æ›¿æ¢åŸåˆ™ (LSP)
é”™è¯¯ç±»å±‚æ¬¡ç»“æ„ï¼š
```typescript
PublisherError
  â”œâ”€ ValidationError
  â”œâ”€ RegistryError
  â”œâ”€ VersionError
  â”œâ”€ GitError
  â”œâ”€ PublishError
  â””â”€ ConfigError
```

## ğŸ”Œ æ‰©å±•ç‚¹

### 1. ç”Ÿå‘½å‘¨æœŸé’©å­
åœ¨å‘å¸ƒæµç¨‹çš„å„ä¸ªé˜¶æ®µæ³¨å…¥è‡ªå®šä¹‰é€»è¾‘

### 2. è‡ªå®šä¹‰éªŒè¯å™¨
é€šè¿‡ `customValidators` æ·»åŠ ä¸šåŠ¡éªŒè¯é€»è¾‘

### 3. ç¼“å­˜ç­–ç•¥
å¯ä»¥æ›¿æ¢é»˜è®¤çš„ MemoryCache å®ç°

### 4. é”™è¯¯å¤„ç†
å¯ä»¥è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç­–ç•¥

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. å¹¶è¡Œå¤„ç†
- ç‹¬ç«‹åŒ…å¹¶è¡Œæ„å»º
- ç‹¬ç«‹åŒ…å¹¶è¡Œå‘å¸ƒ
- ä½¿ç”¨ `Promise.allSettled` é¿å…å•ç‚¹å¤±è´¥

### 2. ç¼“å­˜ä¼˜åŒ–
- Git æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆå‡å°‘ ~70% é‡å¤æŸ¥è¯¢ï¼‰
- NPM Registry æŸ¥è¯¢ç¼“å­˜
- å·¥ä½œç©ºé—´ä¿¡æ¯ç¼“å­˜

### 3. å†…å­˜ç®¡ç†
- LRU é©±é€ç­–ç•¥ï¼ˆé¿å…ç¼“å­˜æ— é™å¢é•¿ï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- å¯é…ç½®çš„ç¼“å­˜å¤§å°é™åˆ¶

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- æ‰«æ `.env` æ–‡ä»¶
- æ£€æµ‹å¯†é’¥æ–‡ä»¶
- éªŒè¯ Token å’Œå¯†ç 

### 2. éªŒè¯æœºåˆ¶
- Git å·¥ä½œåŒºæ£€æŸ¥
- åˆ†æ”¯æƒé™æ£€æŸ¥
- NPM å‡­è¯éªŒè¯

### 3. å›æ»šæœºåˆ¶
- Unpublishï¼ˆ24å°æ—¶å†…ï¼‰
- Deprecateï¼ˆåºŸå¼ƒç‰ˆæœ¬ï¼‰
- Git å›æ»šæŒ‡å¯¼

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- æ¯ä¸ªæ ¸å¿ƒç±»éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•
- Mock å¤–éƒ¨ä¾èµ–
- è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯

### 2. é›†æˆæµ‹è¯•
- æµ‹è¯•æ¨¡å—é—´çš„åä½œ
- æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµ

### 3. ç«¯åˆ°ç«¯æµ‹è¯•
- æµ‹è¯• CLI å‘½ä»¤
- ä½¿ç”¨ Verdaccio æµ‹è¯•çœŸå®å‘å¸ƒ

## ğŸ“š æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†
```typescript
try {
  await operation()
} catch (error: any) {
  throw new SpecificError(
    'æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯',
    { context: 'details' },
    'ä¿®å¤å»ºè®®'
  )
}
```

### 2. æ—¥å¿—è®°å½•
```typescript
logger.info('æ“ä½œå¼€å§‹')
logger.debug('è°ƒè¯•ä¿¡æ¯')
logger.success('æ“ä½œæˆåŠŸ')
logger.error('æ“ä½œå¤±è´¥')
```

### 3. é…ç½®ç®¡ç†
```typescript
import { defineConfig } from '@ldesign/publisher'

export default defineConfig({
  // ç±»å‹å®‰å…¨çš„é…ç½®
})
```

### 4. æ‰©å±•åŠŸèƒ½
```typescript
// é€šè¿‡é’©å­æ‰©å±•
hooks: {
  postPublish: async (report) => {
    // è‡ªå®šä¹‰é€»è¾‘
  }
}
```

## ğŸ”® æœªæ¥å±•æœ›

### çŸ­æœŸè®¡åˆ’
- å®Œå–„é›†æˆæµ‹è¯•
- ä¼˜åŒ–è¿›åº¦åé¦ˆï¼ˆlistr2ï¼‰
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### ä¸­æœŸè®¡åˆ’
- é€šçŸ¥ç³»ç»Ÿé›†æˆ
- å‘å¸ƒå®¡æ‰¹æµç¨‹
- é…ç½®å‘å¯¼

### é•¿æœŸè®¡åˆ’
- æ’ä»¶ç³»ç»Ÿ
- Web UI
- æ›´å¤šå¹³å°æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-25  
**ä½œè€…**: LDesign Team

