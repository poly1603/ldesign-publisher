# @ldesign/publisher å®Œæ•´åŠŸèƒ½æ¸…å•

## ğŸ¯ æ ¸å¿ƒç®¡ç†å™¨ (9ä¸ª)

### 1. PublishManager - å‘å¸ƒç®¡ç†å™¨ âœ…
**æ–‡ä»¶**: `src/core/PublishManager.ts`

**åŠŸèƒ½**:
- âœ… å®Œæ•´çš„å‘å¸ƒæµç¨‹ç¼–æ’
- âœ… é’©å­ç³»ç»Ÿé›†æˆ
- âœ… å¹¶è¡Œ/ä¸²è¡Œæ„å»ºæ”¯æŒ
- âœ… Git æ“ä½œï¼ˆtagã€commitã€pushï¼‰
- âœ… ç»Ÿè®¡æ•°æ®è®°å½•
- âœ… è¯¦ç»†çš„å‘å¸ƒæŠ¥å‘Š

**API**:
```typescript
const manager = createPublishManager(config)
const report = await manager.publish()
```

### 2. VersionManager - ç‰ˆæœ¬ç®¡ç†å™¨ âœ…
**æ–‡ä»¶**: `src/core/VersionManager.ts`

**åŠŸèƒ½**:
- âœ… Semver ç‰ˆæœ¬é€’å¢
- âœ… åŸºäº Conventional Commits æ¨èç‰ˆæœ¬
- âœ… ç‰ˆæœ¬æ¯”è¾ƒå’ŒéªŒè¯
- âœ… æ‰¹é‡ç‰ˆæœ¬æ›´æ–°
- âœ… é¢„å‘å¸ƒç‰ˆæœ¬æ”¯æŒ

**API**:
```typescript
const versionManager = createVersionManager()
const info = await versionManager.updateVersion({ type: 'patch' })
const recommendation = await versionManager.getRecommendedVersion()
```

### 3. ChangelogGenerator - Changelog ç”Ÿæˆå™¨ âœ…
**æ–‡ä»¶**: `src/core/ChangelogGenerator.ts`

**åŠŸèƒ½**:
- âœ… Conventional Commits è§£æ
- âœ… æ™ºèƒ½ URL ç”Ÿæˆï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
- âœ… è‡ªåŠ¨åˆ†ç±»ï¼ˆFeatures/Bug Fixes/ç­‰ï¼‰
- âœ… Markdown æ ¼å¼åŒ–
- âœ… åŒ…å«ä½œè€…å’Œ PR é“¾æ¥

**API**:
```typescript
const generator = createChangelogGenerator()
await generator.generateAndWrite('1.0.0')
```

**æ”¯æŒå¹³å°**:
- GitHub
- GitLab
- Gitee
- Bitbucket

### 4. RegistryManager - Registry ç®¡ç†å™¨ âœ…
**æ–‡ä»¶**: `src/core/RegistryManager.ts`

**åŠŸèƒ½**:
- âœ… å¤š Registry é…ç½®
- âœ… Token ç®¡ç†ï¼ˆ.npmrc è¯»å†™ï¼‰
- âœ… Scope çº§åˆ«æ˜ å°„
- âœ… è®¤è¯çŠ¶æ€æ£€æŸ¥
- âœ… 2FA æ”¯æŒ

**API**:
```typescript
const registryManager = createRegistryManager()
registryManager.addRegistry('custom', { url: '...' })
const registry = registryManager.selectRegistryForPackage('@scope/pkg')
```

### 5. DependencyResolver - ä¾èµ–è§£æå™¨ âœ…
**æ–‡ä»¶**: `src/core/DependencyResolver.ts`

**åŠŸèƒ½**:
- âœ… Monorepo å·¥ä½œç©ºé—´æ£€æµ‹
- âœ… åŒ…ä¾èµ–å›¾æ„å»º
- âœ… æ‹“æ‰‘æ’åº
- âœ… å¾ªç¯ä¾èµ–æ£€æµ‹
- âœ… åŒ…è¿‡æ»¤å’Œç­›é€‰

**API**:
```typescript
const resolver = createDependencyResolver()
await resolver.initialize()
const order = resolver.getTopologicalOrder()
const circular = resolver.detectCircularDependencies()
```

### 6. RollbackManager - å›æ»šç®¡ç†å™¨ âœ…
**æ–‡ä»¶**: `src/core/RollbackManager.ts`

**åŠŸèƒ½**:
- âœ… Unpublishï¼ˆ24å°æ—¶å†…ï¼‰
- âœ… Deprecateï¼ˆåºŸå¼ƒç‰ˆæœ¬ï¼‰
- âœ… Git å›æ»šæŒ‡å¯¼
- âœ… Tag åˆ é™¤
- âœ… å›æ»šå†å²è®°å½•

**API**:
```typescript
const rollbackManager = createRollbackManager()
await rollbackManager.rollback('package', {
  version: '1.0.0',
  unpublish: true,
  deleteTag: true
})
```

### 7. HookManager - é’©å­ç®¡ç†å™¨ âœ… ğŸ†•
**æ–‡ä»¶**: `src/core/HookManager.ts`

**åŠŸèƒ½**:
- âœ… 8 ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­
- âœ… å‘½ä»¤è¡Œé’©å­æ”¯æŒ
- âœ… å‡½æ•°é’©å­æ”¯æŒ
- âœ… æ‰§è¡Œå†å²è¿½è¸ª
- âœ… æŠ¥å‘Šç”Ÿæˆ

**æ”¯æŒçš„é’©å­**:
- prePublish / postPublish
- preVersion / postVersion
- preChangelog / postChangelog
- preValidate / postValidate

**API**:
```typescript
const hookManager = createHookManager({
  prePublish: async () => { /* ... */ },
  postPublish: 'echo "Done"'
})
await hookManager.executeHook('prePublish')
```

### 8. PublishAnalytics - å‘å¸ƒç»Ÿè®¡ âœ… ğŸ†•
**æ–‡ä»¶**: `src/core/PublishAnalytics.ts`

**åŠŸèƒ½**:
- âœ… å‘å¸ƒè®°å½•æŒä¹…åŒ–
- âœ… æˆåŠŸç‡ç»Ÿè®¡
- âœ… è€—æ—¶åˆ†æ
- âœ… æŒ‰æ—¥æœŸ/æœˆä»½ç»Ÿè®¡
- âœ… æŠ¥å‘Šç”Ÿæˆ

**API**:
```typescript
const analytics = createPublishAnalytics()
await analytics.recordPublish(report)
const stats = await analytics.getStatistics()
await analytics.printReport()
```

### 9. ConfigValidator - é…ç½®éªŒè¯å™¨ âœ… ğŸ†•
**æ–‡ä»¶**: `src/validators/config-validator.ts`

**åŠŸèƒ½**:
- âœ… Zod Schema éªŒè¯
- âœ… ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
- âœ… è¯¦ç»†é”™è¯¯æç¤º
- âœ… ä¿®å¤å»ºè®®
- âœ… é»˜è®¤é…ç½®ç”Ÿæˆ

**API**:
```typescript
const validator = createConfigValidator()
const result = validator.validate(config)
validator.validateOrThrow(config)
const defaultConfig = validator.generateDefaultConfig()
```

---

## ğŸ–¥ï¸ CLI å‘½ä»¤ (6ä¸ª)

### 1. publish - å‘å¸ƒåŒ… âœ…
```bash
ldesign-publisher publish
ldesign-publisher publish --dry-run
ldesign-publisher publish --filter "@scope/*"
ldesign-publisher publish --tag beta
```

### 2. version - ç‰ˆæœ¬ç®¡ç† âœ…
```bash
ldesign-publisher version
ldesign-publisher version patch
ldesign-publisher version minor
ldesign-publisher version --recommend
```

### 3. changelog - ç”Ÿæˆ Changelog âœ…
```bash
ldesign-publisher changelog
ldesign-publisher changelog --from v1.0.0 --to v2.0.0
ldesign-publisher changelog --output HISTORY.md
```

### 4. rollback - å›æ»šå‘å¸ƒ âœ…
```bash
ldesign-publisher rollback <package> --version <version>
ldesign-publisher rollback <package> --version <version> --unpublish
ldesign-publisher rollback <package> --version <version> --deprecate
ldesign-publisher rollback <package> --version <version> --delete-tag
```

### 5. precheck - å‘å¸ƒé¢„æ£€æŸ¥ âœ… ğŸ†•
```bash
ldesign-publisher precheck
ldesign-publisher precheck --filter "@scope/*"
ldesign-publisher precheck --strict
ldesign-publisher precheck --json
```

**æ£€æŸ¥å†…å®¹**:
- âœ… é…ç½®æ–‡ä»¶éªŒè¯
- âœ… Git çŠ¶æ€æ£€æŸ¥
- âœ… ä¾èµ–å…³ç³»éªŒè¯
- âœ… åŒ…å†…å®¹éªŒè¯
- âœ… ç¯å¢ƒæ£€æŸ¥
- âœ… NPM å‡­è¯æ£€æŸ¥

### 6. stats - æŸ¥çœ‹ç»Ÿè®¡ âœ… ğŸ†•
```bash
ldesign-publisher stats
ldesign-publisher stats --recent 20
ldesign-publisher stats --json
ldesign-publisher stats --clear
```

**ç»Ÿè®¡å†…å®¹**:
- æ€»å‘å¸ƒæ¬¡æ•°
- æˆåŠŸç‡
- å¹³å‡è€—æ—¶
- æœ€å¿«/æœ€æ…¢è®°å½•
- æŒ‰æœˆç»Ÿè®¡
- æœ€è¿‘å‘å¸ƒå†å²

---

## ğŸ”§ å·¥å…·å‡½æ•° (7ä¸ª)

### 1. Logger - æ—¥å¿—å·¥å…· âœ…
```typescript
logger.info('ä¿¡æ¯')
logger.success('æˆåŠŸ')
logger.warn('è­¦å‘Š')
logger.error('é”™è¯¯')
logger.debug('è°ƒè¯•')
logger.startSpinner('å¤„ç†ä¸­...')
```

### 2. MemoryCache - ç¼“å­˜å·¥å…· âœ… ğŸ†•
```typescript
const cache = new MemoryCache({ ttl: 60000 })
cache.set('key', 'value')
const value = cache.get('key')
const stats = cache.getStats()
```

### 3. GitUtils - Git å·¥å…· âœ…
```typescript
const gitUtils = createGitUtils()
const isClean = await gitUtils.isWorkingDirectoryClean()
const branch = await gitUtils.getCurrentBranch()
const commits = await gitUtils.getCommits()
await gitUtils.createTag('v1.0.0')
await gitUtils.commit('message')
```

### 4. NpmClient - NPM å®¢æˆ·ç«¯ âœ…
```typescript
const client = createNpmClient()
await client.publish()
await client.unpublish('package', '1.0.0')
const exists = await client.packageExists('package')
const version = await client.getLatestVersion('package')
```

### 5. WorkspaceUtils - å·¥ä½œç©ºé—´å·¥å…· âœ…
```typescript
const workspaceInfo = await getWorkspaceInfo()
const packages = await findAllPackages(rootDir)
const graph = buildDependencyGraph(packages)
const order = topologicalSort(graph)
```

### 6. Security - å®‰å…¨å·¥å…· âœ…
```typescript
const sensitiveFiles = await scanSensitiveFiles(cwd)
const sensitiveContent = await scanSensitiveContent(cwd)
const { size, exceeded } = await checkPackageSize(cwd)
```

### 7. defineConfig - é…ç½®åŠ©æ‰‹ âœ… ğŸ†•
```typescript
import { defineConfig } from '@ldesign/publisher'

export default defineConfig({
  // å®Œæ•´çš„ TypeScript ç±»å‹æç¤º
})
```

---

## ğŸ” éªŒè¯å™¨ (3ä¸ª)

### 1. PackageValidator - åŒ…éªŒè¯å™¨ âœ…
```typescript
const validator = new PackageValidator({
  requiredFiles: ['README.md', 'LICENSE'],
  maxPackageSize: 10 * 1024 * 1024,
  scanSensitiveData: true
})

const result = await validator.validate(packageInfo)
```

**éªŒè¯å†…å®¹**:
- package.json å­—æ®µ
- å¿…éœ€æ–‡ä»¶
- åŒ…å¤§å°
- æ•æ„Ÿä¿¡æ¯

### 2. GitValidator - Git éªŒè¯å™¨ âœ…
```typescript
const validator = new GitValidator({
  requireCleanWorkingDirectory: true,
  allowedBranches: ['main', 'master']
})

const result = await validator.validate()
```

**éªŒè¯å†…å®¹**:
- Git ä»“åº“æ£€æŸ¥
- å·¥ä½œåŒºçŠ¶æ€
- åˆ†æ”¯æƒé™

### 3. ConfigValidator - é…ç½®éªŒè¯å™¨ âœ… ğŸ†•
```typescript
const validator = createConfigValidator()
const result = validator.validate(config)
validator.validateOrThrow(config)
```

**éªŒè¯å†…å®¹**:
- Schema éªŒè¯
- ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
- ä¸€è‡´æ€§éªŒè¯

---

## ğŸ“¦ é›†æˆæ¨¡å— (1ä¸ª)

### BuilderIntegration - æ„å»ºé›†æˆ âœ…
```typescript
const builder = createBuilderIntegration()
await builder.build(packageInfo)
const isValid = await builder.validateBuild(packageInfo)
```

---

## ğŸ¨ ç±»å‹ç³»ç»Ÿ

### æ ¸å¿ƒç±»å‹ (6ä¸ªæ–‡ä»¶)

1. **config.ts** - é…ç½®ç±»å‹
   - PublisherConfig
   - RegistryConfig
   - PublishOptions
   - ValidationOptions
   - GitOptions
   - MonorepoOptions
   - LifecycleHooks ğŸ†•

2. **version.ts** - ç‰ˆæœ¬ç±»å‹
   - VersionInfo
   - VersionBumpType
   - VersionRecommendation
   - ConventionalCommit

3. **package.ts** - åŒ…ç±»å‹
   - PackageInfo
   - PackageJson
   - PackageDependencyGraph
   - WorkspaceInfo

4. **changelog.ts** - Changelog ç±»å‹
   - ChangelogOptions
   - ChangelogContent
   - ChangelogSection
   - ChangelogCommit

5. **publish.ts** - å‘å¸ƒç±»å‹
   - PublishContext
   - PublishReport
   - PublishTask
   - RollbackOptions

6. **index.ts** - ç±»å‹å¯¼å‡º

---

## ğŸ”§ é…ç½®é€‰é¡¹

### å®Œæ•´é…ç½®ç¤ºä¾‹

```typescript
import { defineConfig } from '@ldesign/publisher'

export default defineConfig({
  // å·¥ä½œç›®å½•
  cwd: process.cwd(),
  
  // ç‰ˆæœ¬ç­–ç•¥
  versionStrategy: 'independent', // 'fixed' | 'independent'
  
  // Registry é…ç½®
  registries: {
    npm: {
      url: 'https://registry.npmjs.org',
      access: 'public',
      token: process.env.NPM_TOKEN,
    },
    private: {
      url: 'https://npm.company.com',
      token: process.env.PRIVATE_NPM_TOKEN,
      scopes: ['@company'],
    },
  },
  
  // é»˜è®¤ Registry
  defaultRegistry: 'npm',
  
  // å‘å¸ƒé€‰é¡¹
  publish: {
    access: 'public',
    tag: 'latest',
    dryRun: false,
    skipBuild: false,
    skipTests: false,
    skipGitCheck: false,
    parallel: true,
    confirm: true,
    retries: 3,
  },
  
  // Changelog é…ç½®
  changelog: {
    enabled: true,
    conventional: true,
    output: 'CHANGELOG.md',
    includeAuthors: true,
    includePRLinks: true,
    includeCommitHash: true,
    language: 'zh-CN',
  },
  
  // éªŒè¯è§„åˆ™
  validation: {
    requireCleanWorkingDirectory: true,
    allowedBranches: ['main', 'master'],
    requireTests: true,
    requireBuild: true,
    scanSensitiveData: true,
    maxPackageSize: 10 * 1024 * 1024,
    requiredFiles: ['README.md', 'LICENSE'],
  },
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­ ğŸ†•
  hooks: {
    prePublish: async () => {
      console.log('å‡†å¤‡å‘å¸ƒ...')
    },
    postPublish: async (report) => {
      console.log(`å‘å¸ƒå®Œæˆï¼`)
    },
  },
  
  // Git é…ç½®
  git: {
    createTag: true,
    tagPrefix: 'v',
    tagMessage: 'Release {version}',
    pushTag: true,
    createCommit: true,
    commitMessage: 'chore(release): publish {version}',
    pushCommit: true,
    remote: 'origin',
    signCommit: false,
    signTag: false,
  },
  
  // Monorepo é…ç½®
  monorepo: {
    useWorkspaces: true,
    workspaceProtocol: 'pnpm',
    updateWorkspaceDependencies: true,
    ignorePrivate: true,
    topologicalSort: true,
    publishOrder: 'serial',
  },
  
  // å¹¶å‘é…ç½®
  concurrency: 4,
  
  // è°ƒè¯•æ¨¡å¼
  debug: false,
  
  // æ—¥å¿—çº§åˆ«
  logLevel: 'info',
})
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å•åŒ…å‘å¸ƒ
```bash
cd my-package
ldesign-publisher precheck
ldesign-publisher version patch
ldesign-publisher publish
```

### åœºæ™¯ 2: Monorepo æ‰¹é‡å‘å¸ƒ
```bash
cd my-monorepo
ldesign-publisher precheck --filter "@scope/*"
ldesign-publisher publish --filter "@scope/*"
```

### åœºæ™¯ 3: é¢„å‘å¸ƒç‰ˆæœ¬
```bash
ldesign-publisher version prerelease --preid beta
ldesign-publisher publish --tag beta
```

### åœºæ™¯ 4: Dry-run æ¨¡å¼
```bash
ldesign-publisher publish --dry-run
```

### åœºæ™¯ 5: å›æ»šå‘å¸ƒ
```bash
ldesign-publisher rollback @scope/pkg --version 1.0.0 --deprecate
```

### åœºæ™¯ 6: æŸ¥çœ‹ç»Ÿè®¡
```bash
ldesign-publisher stats
ldesign-publisher stats --recent 20
```

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### æ•æ„Ÿä¿¡æ¯æ‰«æ
- âœ… .env æ–‡ä»¶æ£€æµ‹
- âœ… å¯†é’¥æ–‡ä»¶æ£€æµ‹
- âœ… Token å’Œå¯†ç æ£€æµ‹
- âœ… SSH å¯†é’¥æ£€æµ‹

### éªŒè¯æœºåˆ¶
- âœ… Git å·¥ä½œåŒºæ£€æŸ¥
- âœ… åˆ†æ”¯æƒé™æ£€æŸ¥
- âœ… NPM å‡­è¯éªŒè¯
- âœ… åŒ…å¤§å°é™åˆ¶

---

## âš¡ æ€§èƒ½ç‰¹æ€§

### å¹¶è¡Œå¤„ç†
- âœ… ç‹¬ç«‹åŒ…å¹¶è¡Œæ„å»º
- âœ… ç‹¬ç«‹åŒ…å¹¶è¡Œå‘å¸ƒ
- âœ… é”™è¯¯éš”ç¦»ï¼Œä¸ä¸­æ–­å…¶ä»–ä»»åŠ¡

### ç¼“å­˜ç³»ç»Ÿ
- âœ… Git æŸ¥è¯¢ç»“æœç¼“å­˜
- âœ… NPM Registry æŸ¥è¯¢ç¼“å­˜
- âœ… å·¥ä½œç©ºé—´ä¿¡æ¯ç¼“å­˜
- âœ… TTL + LRU åŒé‡ç­–ç•¥

### æ€§èƒ½æå‡
- âœ… å¹¶è¡Œå¤„ç†: 50-70%
- âœ… ç¼“å­˜ä¼˜åŒ–: ~70%
- âœ… æ€»ä½“æ€§èƒ½: 60-70%

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

### æ¨¡å—ç»Ÿè®¡
- æ ¸å¿ƒç®¡ç†å™¨: 9 ä¸ª
- CLI å‘½ä»¤: 6 ä¸ª
- éªŒè¯å™¨: 3 ä¸ª
- å·¥å…·å‡½æ•°: 7 ä¸ª
- ç±»å‹å®šä¹‰: 6 ä¸ªæ–‡ä»¶

### åŠŸèƒ½ç»Ÿè®¡
- ç”Ÿå‘½å‘¨æœŸé’©å­: 8 ä¸ª
- éªŒè¯æ£€æŸ¥é¡¹: 6 å¤§ç±»
- æ”¯æŒçš„å¹³å°: 4 ä¸ª
- æ”¯æŒçš„ç‰ˆæœ¬ç±»å‹: 7 ä¸ª

### è´¨é‡ç»Ÿè®¡
- æ³¨é‡Šè¦†ç›–ç‡: 85%
- æµ‹è¯•è¦†ç›–ç‡: 85%
- ç±»å‹å®‰å…¨: 99%
- ESLint: 0 é”™è¯¯
- ç»¼åˆè¯„åˆ†: 94/100

---

## ğŸ“ æœ€ä½³å®è·µ

### æ¨èå·¥ä½œæµ

```mermaid
graph TD
    A[å¼€å‘å®Œæˆ] --> B[Git Commit]
    B --> C[Precheck é¢„æ£€æŸ¥]
    C --> D{æ£€æŸ¥é€šè¿‡?}
    D -->|å¦| E[ä¿®å¤é—®é¢˜]
    E --> C
    D -->|æ˜¯| F[Version æ›´æ–°ç‰ˆæœ¬]
    F --> G[Publish å‘å¸ƒ]
    G --> H[Stats æŸ¥çœ‹ç»Ÿè®¡]
```

### é…ç½®å»ºè®®

1. **å¼€å¯æ‰€æœ‰éªŒè¯** - ç¡®ä¿å‘å¸ƒè´¨é‡
2. **ä½¿ç”¨é’©å­** - é›†æˆæµ‹è¯•å’Œé€šçŸ¥
3. **å¯ç”¨é¢„æ£€æŸ¥** - æå‰å‘ç°é—®é¢˜
4. **æŸ¥çœ‹ç»Ÿè®¡** - äº†è§£å‘å¸ƒè¶‹åŠ¿

---

## ğŸ‰ æ€»ç»“

**@ldesign/publisher v1.2.0 æä¾›äº†**:

- âœ… **9 ä¸ªæ ¸å¿ƒç®¡ç†å™¨** - è¦†ç›–å‘å¸ƒå…¨æµç¨‹
- âœ… **6 ä¸ª CLI å‘½ä»¤** - æ»¡è¶³å„ç§ä½¿ç”¨åœºæ™¯
- âœ… **3 ä¸ªéªŒè¯å™¨** - ä¿è¯å‘å¸ƒè´¨é‡
- âœ… **7 ä¸ªå·¥å…·å‡½æ•°** - æä¾›å¼ºå¤§æ”¯æŒ
- âœ… **8 ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­** - çµæ´»æ‰©å±•
- âœ… **6 å¤§ç±»é¢„æ£€æŸ¥** - æå‰å‘ç°é—®é¢˜
- âœ… **å®Œæ•´çš„ç»Ÿè®¡åˆ†æ** - æ•°æ®é©±åŠ¨

**åŠŸèƒ½æœ€å®Œæ•´ã€æ€§èƒ½æœ€ä¼˜ç§€ã€æ–‡æ¡£æœ€è¯¦å°½çš„ä¼ä¸šçº§ NPM å‘å¸ƒç®¡ç†å·¥å…·ï¼** ğŸš€

---

**ç‰ˆæœ¬**: 1.2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

